worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # 도커 내장 DNS
    resolver 127.0.0.11 valid=30s ipv6=off;

    server {
        server_name tychicus-dev.icoramdeo.com;

        location / {
            # 여기서 바로 호스트를 쓰지 않고, 변수에 담아서 proxy_pass
            set $upstream "http://tychicus-dev:80";
            proxy_pass $upstream;

            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }

        listen 443 ssl;
        ssl_certificate     /etc/letsencrypt/live/tychicus-dev.icoramdeo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/tychicus-dev.icoramdeo.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name tychicus.icoramdeo.com;

        location / {
            set $upstream "http://tychicus-prod:80";
            proxy_pass $upstream;

            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }

        listen 443 ssl;
        ssl_certificate     /etc/letsencrypt/live/tychicus.icoramdeo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/tychicus.icoramdeo.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name tychicus-dashboard-dev.icoramdeo.com;

        location / {
            set $upstream "http://tychicus-dashboard-dev:80";
            proxy_pass $upstream;

            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }

        listen 443 ssl;
        ssl_certificate     /etc/letsencrypt/live/tychicus-dashboard-dev.icoramdeo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/tychicus-dashboard-dev.icoramdeo.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    server {
        server_name tychicus-dashboard.icoramdeo.com;

        location / {
            set $upstream "http://tychicus-dashboard-prod:80";
            proxy_pass $upstream;

            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }

        listen 443 ssl;
        ssl_certificate     /etc/letsencrypt/live/tychicus-dashboard.icoramdeo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/tychicus-dashboard.icoramdeo.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    # HTTP → HTTPS 리다이렉트 (dev)
    server {
        listen 80;
        server_name tychicus-dev.icoramdeo.com;

        if ($host = tychicus-dev.icoramdeo.com) {
            return 301 https://$host$request_uri;
        }

        return 404;
    }

    # HTTP → HTTPS 리다이렉트 (prod)
    server {
        listen 80;
        server_name tychicus.icoramdeo.com;

        if ($host = tychicus.icoramdeo.com) {
            return 301 https://$host$request_uri;
        }

        return 404;
    }

    # HTTP → HTTPS 리다이렉트 (dev)
    server {
        listen 80;
        server_name tychicus-dashboard-dev.icoramdeo.com;

        if ($host = tychicus-dashboard-dev.icoramdeo.com) {
            return 301 https://$host$request_uri;
        }
    }

    # HTTP → HTTPS 리다이렉트 (prod)
    server {
        listen 80;
        server_name tychicus-dashboard.icoramdeo.com;

        if ($host = tychicus-dashboard.icoramdeo.com) {
            return 301 https://$host$request_uri;
        }
    }
}